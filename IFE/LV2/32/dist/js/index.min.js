function addEvent(e,t,a,n){e.addEventListener?e.addEventListener(t,a,n||!1):e.attachEvent.call(e,t,a)}function extend(e,t){function a(){}a.prototype=t.prototype,e.prototype=new a,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor===Object.prototype.constructor&&(t.prototype.constructor=t)}function Interface(e,t){if(2!==arguments.length)throw new Error("The Interface constructor requires exactly 2 arguments(No.1 name and No.2 methods).And you provide "+arguments.length);this.methods=[];for(var a=0,n=t.length;n>a;a++){if("string"!=typeof t[a])throw new Error("The Interface constructor expects method name to be passed as a string.");this.methods[a]=t[a]}}function ensureImplements(e){var t=arguments.length;if(2>t)throw new Error("Without Interface object, how can we examine the obj!");for(var a=0;++a>t;){var n=arguments[a];if(!(n instanceof Interface))throw new Error("Function Interface.ensureImplements expects argumentsNo.2 and above to be instances of Interface");var i=0;for(n.length;t>i;i++){var s=n.methods[i];if(!e[s]||"function"!=typeof e[s])throw new Error("Function Interface.ensureImplements: object doesn't implement the "+n.name+" interface.method"+s+"was not found.")}}}function existInWord(e,t){var a=new RegExp("\\b"+t+"\\b");return a.test(e)}function replaceWord(e,t,a){var n=new RegExp("\\b"+t+"\\b");return existInWord(e,t)&&(e=e.replace(n,a)),e}function hasClass(e,t){return existInWord(e.className,t)}function addClass(e,t){existInWord(e.className,t)||(e.className+=" "+t)}function removeClass(e,t){existInWord(e.className,t)&&(e.className=replaceWord(e.className,t,""))}function createElement(e){e=e||{};var t=document.createElement(e.tag||"div");return t.id=e.id||"",t.className=e.className||"",t.type=e.type||"",t}function Form(e,t,a){if(this.id=e,this.formItems={},this.element=createElement({tag:"form",id:e,className:t}),this.button=createElement({tag:"button"}),this.button.innerHTML="提交","undefined"!=typeof a){var n=createElement({tag:"h3"});n.innerHTML=a,this.element.appendChild(n)}this.element.appendChild(this.button);var i=this;addEvent(this.button,"click",function(e){e=e||window.event,e.preventDefault?e.preventDefault():e.returnValue=!1,i.validate()&&(console.log(i.getValue()),i.callback&&i.callback(i.getValue()))})}function InputField(e){this.name=e.name,this.conf=e,this.element=createElement({tag:"fieldset",className:e["class"]["default"]}),this.label=createElement({tag:"label",className:"form-item-title"}),this.input=createElement({tag:"input",className:"form-item-input",type:e.type}),this.tip=createElement({tag:"span",className:"form-item-tip"}),this.required=e.required,this.diyValidate=e.validate,this.label.innerHTML=e.label,this.status="default",this.input.placeholder=e.placeholder,this.element.appendChild(this.label),this.element.appendChild(this.input),this.element.appendChild(this.tip);var t=this;addEvent(this.input,"focus",function(){t.reset()}),addEvent(this.input,"blur",function(){t.validate()})}function TextareField(e){this.name=e.name,this.conf=e,this.element=createElement({tag:"fieldset",className:e["class"]["default"]}),this.label=createElement({tag:"label",className:"form-item-title"}),this.input=createElement({tag:"textarea",className:"form-item-input"}),this.tip=createElement({tag:"span",className:"form-item-tip"}),this.required=e.required,this.diyValidate=e.validate,this.label.innerHTML=e.label,this.input.placeholder=e.placeholder,this.element.appendChild(this.label),this.element.appendChild(this.input),this.element.appendChild(this.tip);var t=this;addEvent(this.input,"focus",function(){t.reset()}),addEvent(this.input,"blur",function(){t.validate()})}function SelectField(e){var t,a=e.options,n=!1;if("undefined"==typeof a)return void console.log("组件识别名: "+e.name+"未配置选项");this.input=createElement({tag:"select",className:"form-item-input"});for(var i in a)n=!0,t=createElement({tag:"option"}),t.value=a[i],t.innerHTML=i,this.input.appendChild(t);if(!n)return void console.log("组件识别名: "+e.name+"选项为空");this.conf=e,this.name=e.name,this.required=e.required,this.element=createElement({tag:"fieldset",className:e["class"]["default"]}),this.label=createElement({tag:"label",className:"form-item-title"}),this.tip=createElement({tag:"span",className:"form-item-tip"}),this.label.innerHTML=e.label,this.element.appendChild(this.label),this.element.appendChild(this.input),this.element.appendChild(this.tip);var s=this;addEvent(this.input,"focus",function(){s.reset()}),addEvent(this.input,"blur",function(){s.validate()})}function ChooseField(e){var t,a,n=e.options;if("undefined"==typeof n)return void console.log("组件识别名: "+e.name+"没有配置选项");var i=!1;this.input=createElement({tag:"div",className:"form-item-input"});var s=0;for(var r in n)i=!0,t=createElement({id:e.name+s,tag:"input",type:e.type}),a=createElement({tag:"label"}),a.setAttribute("for",e.name+s),t.setAttribute("name",e.name),a.innerHTML=r,t.innerHTML=r,t.value=n[r],this.input.appendChild(a),this.input.appendChild(t),s++;if(!i)return void console.log("组件识别名: "+e.name+"选项为空");this.conf=e,this.name=e.name,this.required=e.required,this.element=createElement({tag:"fieldset",className:e["class"]["default"]}),this.label=createElement({tag:"label",className:"form-item-title"}),this.tip=createElement({tag:"span",className:"form-item-tip"}),this.label.innerHTML=e.label,this.element.appendChild(this.label),this.element.appendChild(this.input),this.element.appendChild(this.tip),this.reset();var l=this;addEvent(this.input,"click",function(e){e=e||window.event;var t=e.target||e.srcElement;"input"!==t.tagName.toLowerCase()&&"label"!==t.tagName.toLowerCase()||l.validate()})}function Validator(){}function Store(e){this.validator=e}function createForm(e,t,a,n,i,s){var r,l,o=new Form(e,t,n);if(s)for(;r=s.shift();)l=i.create(r),o.addChild(l);return a.appendChild(o.getElement()),o}var FormMoudel=new Interface("FormMoudel",["addChild","getValue","validate"]),InputMoudel=new Interface("InputMoudel",["getValue","validate"]);Form.prototype={addChild:function(e){ensureImplements(e,InputMoudel);var t=e.name;return this.formItems[t]?(console.log(this.id+" 表单: \n组件名: "+e.name+" 已存在"),void this.formItems[t].validate()):(e.parent=this,this.formItems[t]=e,void this.element.insertBefore(e.getElement(),this.button))},getValue:function(){var e=this.formItems,t={};if(this.validate()){for(var a in e)t[a]=e[a].getValue();return t}console.log(this.name+"验证失败！")},validate:function(){var e=this.formItems,t=!0;for(var a in e)if(!e[a].validate()){t=!1,this.fail&&this.fail();break}return t&&this.success&&this.success(),t},setCallback:function(e){"function"==typeof e&&(this.callback=e)},getElement:function(){return this.element}},extend(InputField,Form),InputField.prototype.getValue=function(){return this.input.value},InputField.prototype.validate=function(){var e=this.getValue(),t=!0;return 0!==e.length||this.required?(t=this.diyValidate(this.getValue()),t?this.status="passed":this.status="error"):this.status="",this.setTip(),t},InputField.prototype.reset=function(){var e=this.conf;this.element.className=e["class"]["default"]+" "+e["class"].focus,this.tip.innerHTML=e.mes.focus},InputField.prototype.fail=function(){var e=this.conf;this.element.className=e["class"]["default"]+" "+e["class"].fail,this.tip.innerHTML=e.mes.fail},InputField.prototype.success=function(){var e=this.conf;this.element.className=e["class"]["default"]+" "+e["class"].success,this.tip.innerHTML=e.mes.success},InputField.prototype.setTip=function(){var e,t=this.status,a=this.conf;switch(t){case"error":this.element.className=a["class"]["default"]+" "+a["class"].fail,e=a.mes.fail;break;case"passed":this.element.className=a["class"]["default"]+" "+a["class"].success,e=a.mes.success;break;case"hidden":this.element.style.display="none";break;default:this.element.className=a["class"]["default"]}this.tip.innerHTML=e||""},extend(TextareField,InputField),extend(SelectField,InputField),SelectField.prototype.getValue=function(){for(var e=[],t=this.input.options,a=0,n=t.length;n>a;a++)t[a].selected&&e.push(t[a].value);return e.join(",")},SelectField.prototype.validate=function(){var e=this.getValue(),t=!0;return 0!==e.length||this.required?(t=!!e.length,t?this.status="passed":this.status="error"):this.status="",this.setTip(),t},extend(ChooseField,SelectField),ChooseField.prototype.getValue=function(){var e=this.element.elements,t=e.length;return this.getValue=function(){for(var a=[],n=0;t>n;n++)e[n].checked&&a.push(e[n].value);return a.join(",")},this.getValue()},Validator.prototype={defaults:{max:-1,min:-1,email:!1,number:!1},create:function(e){var t=this.defaults,a=[];for(var n in t)e[n]=e[n]||t[n];return e.max>0&&e.min>0&&e.max<e.min&&(e.max=e.max-e.min,e.min=e.max+e.min,e.max=e.min-e.max),e.min>0&&a.push(this.minTest(e.min)),e.max>0&&a.push(this.maxTest(e.max)),e.email&&a.push(this.emailTest),e.number&&a.push(this.numberTest),function(e){for(var t=a.length;t-- >0;)if(!a[t](e))return!1;return!0}},maxTest:function(){var e=/[\u0000-\u00ff]/;return function(t){return function(a){for(var n=0,i=0,s=a.length;s>i;i++)if(e.test(a.charAt(i))?n++:n+=2,n>t)return!1;return!0}}}(),minTest:function(){var e=/[\u0000-\u00ff]/;return function(t){return function(a){for(var n=0,i=0,s=a.length;s>i;i++)if(e.test(a.charAt(i))?n++:n+=2,n>=t)return!0;return!1}}}(),numberTest:function(){var e=/^-?\d+$/;return function(t){return e.test(t)}}(),emailTest:function(){var e=/^[a-zA-z\d]([\.\_\-]*[a-zA-z\d]+)*\@[a-zA-z\d]+(\.[a-zA-Z]{2,5})+$/;return function(t){return e.test(t)}}()},Store.prototype={create:function(e){var t;"function"==typeof e.validate&&(t=e.validate),e=this.modify(e),t?e.validate=t:e.validate=this.validator.create(e.validate);var a,n=e.type.toLowerCase();switch(n){case"textarea":case"select":a=n;break;case"radio":case"checkbox":a="choose";break;default:a="input"}return new this.modules[a](e)},modify:function(){function e(t){var a=arguments.length;if(2>a)return!1;var n=Array.prototype.slice.call(arguments,1),i={};a-=1;for(var s=0;a>s;s++)for(var r in n[s])t&&"object"==typeof n[s][r]?("object"!=typeof i[r]&&(i[r]={}),i[r]=e(!0,i[r],n[s][r])):i.hasOwnProperty(r)&&""!==i[r]||(i[r]=n[s][r]);return i}return function(t){return e(!0,t,this.defaults)}}()},formStore=new Store(new Validator),formStore.modules={textarea:TextareField,choose:ChooseField,input:InputField,select:SelectField},formStore.defaults={name:"",label:"",type:"",required:!1,placeholder:"",validate:{max:-1,min:-1,number:!1,email:!1},"class":{"default":"form-items",fail:"fail",success:"success",focus:"focus"},mes:{focus:"",success:"验证通过",fail:"格式不符"},options:{}};var show=document.getElementById("show"),form1=createForm("form1","form",show,"此表单生产新输入组件并加入新表单",formStore,[{name:"type",label:"类型:",type:"select",required:!0,mes:{focus:"爷，选一个呗",fail:"必须选一个"},options:{"文本":"text","邮箱":"email","数字":"number","文本框":"textarea","单选框":"radio","多选框":"checkbox","下拉框":"select"}},{name:"label",label:"外部展示用标签名:",placeholder:"不给你自己看着办",validate:{max:12,min:3},mes:{focus:"给个3~12字节的名字呗",success:"验证通过",fail:"格式不符"}},{name:"name",label:"组件内部索引名:",type:"text",mes:{focus:"随意但不可重复(包括空字符)"}},{name:"focus",label:"focus提示:",type:"text",placeholder:"默认为空",required:!1,validate:{max:12,min:1},mes:{focus:"随意"}},{name:"fail",label:"格式错误提示:",type:"text",placeholder:"格式不符",mes:{focus:"随意"}},{name:"success",label:"验证通过提示:",type:"text",placeholder:"验证通过",mes:{focus:"随意"}},{name:"required",label:"需求:",type:"radio",mes:{focus:"选一个呗"},options:{"非必需":!1,"必需":!0}},{name:"max",label:"字数上限:",type:"number",required:!0,validate:{number:!0},mes:{focus:"你要是想666我也没办法,顺带一提负数表示不检查"}},{name:"min",label:"下限:",type:"number",required:!0,validate:{number:!0},mes:{focus:"同上"}},{name:"options",label:"选项:",type:"textarea",required:!0,placeholder:'{\n  "label1": "value1",\n  "label2": "value2"\n}',validate:function(e){try{return JSON.parse(e),!0}catch(t){return!1}},"class":{fail:"fail",success:"success",focus:"focus"},mes:{focus:"接受JSON格式,否则无效"}}]),form2=createForm("form2","form",show,"新表单",formStore);form1.formItems.options.input.defaultValue='{\n  "选项1": "value1",\n  "选项2": "value2",\n  "选项3": "value3",\n  "选项4": "value4"\n}',form1.formItems.label.input.defaultValue="标签名",form1.formItems.name.input.defaultValue="name",form1.formItems.max.input.defaultValue=-1,form1.formItems.min.input.defaultValue=1,form1.formItems.success.input.defaultValue="验证通过",form1.formItems.fail.input.defaultValue="格式错误",form1.setCallback(function(e){function t(e,t,a){for(var n=0,i=a.length;i>n;n++)e.hasOwnProperty(a[n])&&(e[t][a[n]]=e[a[n]],delete e[a[n]])}var a={};for(var n in e)a[n]=e[n];switch(a.validate={},a.mes={},a.type){case"email":a.validate.email=!0;break;case"number":a.validate.number=!0}a.options=JSON.parse(a.options),t(a,"validate",["max","min"]),t(a,"mes",["focus","success","fail"]),a.required&&(a.required="true"===a.required),form2.addChild(formStore.create(a))}),form2.setCallback(function(e){e=JSON.stringify(e).split(",").join(",\n   "),confirm(e)});